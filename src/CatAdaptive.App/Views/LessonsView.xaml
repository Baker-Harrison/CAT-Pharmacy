<UserControl x:Class="CatAdaptive.App.Views.LessonsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800">
    <Grid Margin="30">
        <StackPanel Visibility="{Binding SelectedLesson, Converter={StaticResource NullToCollapsedConverter}}">
            <TextBlock Text="Lessons" FontSize="26" FontWeight="Bold" Foreground="#1E293B" Margin="0,0,0,10"/>
            <TextBlock Text="Generate new lessons when your quiz results arrive." FontSize="13" Foreground="#64748B" Margin="0,0,0,20"/>

            <Border Background="#FEFCE8" BorderBrush="#FDE68A" BorderThickness="1" CornerRadius="8" Padding="12"
                    Visibility="{Binding IsGeneratingLessons, Converter={StaticResource BoolToVisibilityConverter}}">
                <TextBlock Text="Generating new lessons..." FontWeight="SemiBold" Foreground="#92400E"/>
            </Border>

            <ItemsControl ItemsSource="{Binding Lessons}" Margin="0,20,0,0">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Background="White" BorderBrush="#E2E8F0" BorderThickness="1" CornerRadius="10" Padding="18" Margin="0,0,0,15">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Title}" FontSize="16" FontWeight="SemiBold" Foreground="#1E293B"/>
                                    <TextBlock Text="  •  Remediation" Margin="10,0,0,0" FontSize="12" Foreground="#DC2626"
                                               Visibility="{Binding IsRemediation, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                </StackPanel>

                                <TextBlock Text="{Binding Summary}" Foreground="#475569" TextWrapping="Wrap" Margin="0,6,0,10"/>

                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Progress" Foreground="#64748B" FontSize="12" Margin="0,0,10,0"/>
                                    <ProgressBar Width="160" Height="8" Maximum="100" Value="{Binding ProgressPercent}"/>
                                    <TextBlock Text="{Binding LastScorePercent, StringFormat=Score: {0:0}%, TargetNullValue=Score: --}" Foreground="#1E293B" Margin="12,0,0,0"/>
                                </StackPanel>

                                <Button Content="Open Lesson" Margin="0,12,0,0" Padding="12,8" Background="#2563EB" Foreground="White" BorderThickness="0"
                                        Command="{Binding DataContext.OpenLessonCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </StackPanel>

        <ScrollViewer Visibility="{Binding SelectedLesson, Converter={StaticResource NullToVisibilityConverter}}">
            <StackPanel MaxWidth="820">
                <Button Content="← Back to Lessons" Command="{Binding BackToListCommand}" Padding="8,4" Width="140" Background="Transparent" BorderThickness="0"
                        HorizontalAlignment="Left" Foreground="#2563EB"/>

                <TextBlock Text="{Binding SelectedLesson.Title}" FontSize="24" FontWeight="Bold" Foreground="#1E293B" Margin="0,12,0,8"/>
                <TextBlock Text="{Binding SelectedLesson.Summary}" Foreground="#475569" TextWrapping="Wrap" Margin="0,0,0,20"/>

                <ItemsControl ItemsSource="{Binding SelectedLesson.Sections}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Margin="0,0,0,20">
                                <TextBlock Text="{Binding Heading}" FontSize="18" FontWeight="SemiBold" Foreground="#1E293B" Margin="0,0,0,6"/>
                                <TextBlock Text="{Binding Body}" TextWrapping="Wrap" Foreground="#334155"/>
                                <ItemsControl ItemsSource="{Binding Prompts}" Margin="0,10,0,0">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Background="#F8FAFC" BorderBrush="#CBD5E1" BorderThickness="1" CornerRadius="8" Padding="10" Margin="0,0,0,8">
                                                <TextBlock Text="{Binding Prompt}" TextWrapping="Wrap" Foreground="#0F172A"/>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <TextBlock Text="Knowledge Check" FontSize="20" FontWeight="SemiBold" Foreground="#1E293B" Margin="0,10,0,10"/>

                <ItemsControl ItemsSource="{Binding QuizQuestions}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="White" BorderBrush="#E2E8F0" BorderThickness="1" CornerRadius="8" Padding="14" Margin="0,0,0,12">
                                <StackPanel>
                                    <TextBlock Text="{Binding TypeDisplay}" FontSize="12" Foreground="#64748B" Margin="0,0,0,4"/>
                                    <TextBlock Text="{Binding Question.Prompt}" TextWrapping="Wrap" Foreground="#1E293B"/>
                                    <TextBox Text="{Binding ResponseText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="True" MinHeight="80"
                                             TextWrapping="Wrap" Margin="0,8,0,0" BorderBrush="#CBD5E1" Background="#F8FAFC"/>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <TextBlock Text="{Binding StatusMessage}" Foreground="#DC2626" Margin="0,0,0,10"
                           Visibility="{Binding StatusMessage, Converter={StaticResource NullToVisibilityConverter}}"/>

                <Button Content="Submit Quiz" Command="{Binding SubmitQuizCommand}" Padding="16,10" Background="#10B981" Foreground="White" BorderThickness="0"
                        IsEnabled="{Binding IsSubmittingQuiz, Converter={StaticResource InverseBoolConverter}}"/>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
